version: v1beta10
images:
  ntppool:
    dockerfile: Dockerfile.dev
    image: harbor.ntppool.org/ntpdev/ntppool-dev
    tags:
      - dev-${DEVSPACE_GIT_COMMIT}-${DEVSPACE_TIMESTAMP}
      - latest
    injectRestartHelper: true
    build:
      kaniko:
        cache: true
        snapshotMode: full
        image: gcr.io/kaniko-project/executor:v1.6.0
        resources:
          limits:
            cpu: 1000m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi

deployments:
  - name: ntppool
    helm:
      chart:
        name: ntppool
        #name: ../ntppool-charts/charts/ntppool
        repo: https://charts.ntppool.org
      valuesFiles:
        - /Users/ask/src/ntppool-k8s/dev-values-do.yaml
      values:
        image:
          image: harbor.ntppool.org/ntpdev/ntppool-dev
        config:
          manage_hostname: manage.devlon3.grundclock.com
          web_hostname: web.devlon3.grundclock.com
          pool_domain: ntp.devlon3.grundclock.com
          db_dsn: dbi:mysql:database=ntpdev3;host=mysql.ntpdev.svc
          db_user: ntpdev3
          stripe_gw_service: http://stripe-gw.stripe
      wait: true

dev:
  sync:
    - labelSelector:
        app: ntppool
        tier: frontend
      containerName: httpd
      waitInitialSync: false
      localSubPath: ./
      containerPath: /ntppool
      excludePaths:
        - backup/
        - logs/
        - manage2/
        - ".data/"
        - ".git"
        - node_modules/
      downloadExcludePaths:
        - "*"
      disableDownload: true
      onUpload:
        restartContainer: true

#profiles:
#- name: ewrdev
#  replace:
